# AT Agent Accessibility Tests for test-website

stages:
  - test

accessibility-tests:
  stage: test
  image: node:20

  variables:
    PROVIDER: "openai"
    HEADLESS: "true"
    CONTINUE_ON_FAILURE: "true"

  before_script:
    # Install jq for JSON parsing
    - apt-get update && apt-get install -y jq

    # Install test-website dependencies and start the app
    - npm install
    - PORT=3000 npm start &
    - sleep 5
    - npx wait-on http://localhost:3000 --timeout 60000

    # Clone and set up at-agent (uses AT_AGENT_PAT variable for private repo access)
    - git clone --branch langgraph-agent https://oauth2:${AT_AGENT_PAT}@github.com/justanothernoob4648/at-agent.git /at-agent
    - cd /at-agent && npm install
    - npx playwright install --with-deps chromium

  script:
    - |
      cd /at-agent

      RESULTS="[]"
      PASSED=0
      FAILED=0
      TOTAL=0

      # Read the test config file
      TEST_FILE="${CI_PROJECT_DIR}/a11y-tests.json"

      # Get number of tests
      NUM_TESTS=$(jq 'length' "$TEST_FILE")
      echo "Running $NUM_TESTS accessibility tests..."
      echo ""

      # Loop through each test by index
      for i in $(seq 0 $((NUM_TESTS - 1))); do
        TOTAL=$((TOTAL + 1))

        # Extract url and goal using jq
        url=$(jq -r ".[$i].url" "$TEST_FILE")
        goal=$(jq -r ".[$i].goal" "$TEST_FILE")

        echo "==========================================="
        echo "Test $TOTAL of $NUM_TESTS"
        echo "URL: $url"
        echo "Goal: $goal"
        echo "==========================================="

        # Run the test and capture output
        set +e
        OUTPUT=$(npm run start:agent-cli -- "$url" "$goal" "$PROVIDER" --json 2>&1)
        EXIT_CODE=$?
        set -e

        # Extract JSON result from output (look for the JSON object)
        JSON_RESULT=$(echo "$OUTPUT" | grep -o '{"url"[^}]*}' | head -1 || echo '{"success":false,"error":"Failed to parse output"}')

        # Check if we got valid JSON, if not create a failure result
        if ! echo "$JSON_RESULT" | jq . > /dev/null 2>&1; then
          JSON_RESULT="{\"url\":\"$url\",\"goal\":\"$goal\",\"success\":false,\"error\":\"Invalid JSON output\"}"
        fi

        # Get success status
        SUCCESS=$(echo "$JSON_RESULT" | jq -r '.success // false')

        if [ "$SUCCESS" = "true" ]; then
          PASSED=$((PASSED + 1))
          echo "PASSED"
        else
          FAILED=$((FAILED + 1))
          ERROR=$(echo "$JSON_RESULT" | jq -r '.error // .reason // "Unknown error"')
          echo "FAILED: $ERROR"
        fi

        # Add to results array
        RESULTS=$(echo "$RESULTS" | jq --argjson r "$JSON_RESULT" '. + [$r]')

        echo ""
      done

      # Write results
      echo "$RESULTS" > "${CI_PROJECT_DIR}/accessibility-results.json"

      echo "==========================================="
      echo "Summary"
      echo "==========================================="
      echo "Total: $TOTAL"
      echo "Passed: $PASSED"
      echo "Failed: $FAILED"
      echo "==========================================="

      # Exit with failure if any tests failed
      if [ "$FAILED" -gt 0 ]; then
        exit 1
      fi

  artifacts:
    when: always
    paths:
      - accessibility-results.json
    expire_in: 30 days
